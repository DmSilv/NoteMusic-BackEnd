const mongoose = require('mongoose');
require('dotenv').config();

const Module = require('../src/models/Module');
const Quiz = require('../src/models/Quiz');

// Conectar ao banco
const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/notemusic');
    console.log('‚úÖ Conectado ao MongoDB');
  } catch (error) {
    console.error('‚ùå Erro ao conectar:', error);
    process.exit(1);
  }
};

// Limpar dados existentes
const clearExistingData = async () => {
  try {
    console.log('üßπ Limpando dados existentes...');
    
    await Quiz.deleteMany({});
    await Module.deleteMany({});
    
    console.log('‚úÖ Dados existentes removidos');
  } catch (error) {
    console.error('‚ùå Erro ao limpar dados:', error);
    throw error;
  }
};

// Criar m√≥dulos com estrutura correta
const createModulesWithCorrectStructure = async () => {
  try {
    console.log('üìö Criando m√≥dulos com estrutura correta...');
    
    const modules = [
      // N√çVEL APRENDIZ - 8 m√≥dulos
      {
        title: 'Propriedades do Som - Os Pilares da M√∫sica',
        description: 'Aprenda sobre frequ√™ncia, timbre, intensidade e dura√ß√£o do som',
        category: 'propriedades-som',
        level: 'aprendiz',
        order: 1,
        points: 50,
        duration: 15,
        content: {
          theory: 'O som √© uma onda mec√¢nica que se propaga atrav√©s de um meio material. Possui quatro propriedades principais: altura (frequ√™ncia), timbre, intensidade e dura√ß√£o.',
          examples: [
            { title: 'Timbre Instrumental', description: 'Diferentes instrumentos tocando a mesma nota' },
            { title: 'Din√¢mica Musical', description: 'Varia√ß√£o de volume em uma m√∫sica' },
            { title: 'Dura√ß√£o das Notas', description: 'Notas longas e curtas' }
          ],
          exercises: [
            { title: 'Identifica√ß√£o de Propriedades', description: 'Identificar propriedades do som', type: 'audicao' },
            { title: 'Reconhecimento de Timbre', description: 'Reconhecer timbres instrumentais', type: 'audicao' }
          ]
        },
        isActive: true
      },
      {
        title: 'Notas Musicais e Solfejo - O ABC da M√∫sica',
        description: 'Domine as 7 notas musicais e o solfejo b√°sico',
        category: 'solfegio-basico',
        level: 'aprendiz',
        order: 2,
        points: 50,
        duration: 20,
        content: {
          theory: 'As sete notas musicais (D√≥, R√©, Mi, F√°, Sol, L√°, Si) formam a base da m√∫sica ocidental. O solfejo √© a t√©cnica de cantar as notas usando s√≠labas espec√≠ficas.',
          examples: [
            { title: 'Escala de D√≥ Maior', description: 'Sequ√™ncia completa das 7 notas' },
            { title: 'S√≠labas do Solfejo', description: 'D√≥, R√©, Mi, F√°, Sol, L√°, Si' },
            { title: 'Exerc√≠cios Pr√°ticos', description: 'Cantar escalas ascendentes e descendentes' }
          ],
          exercises: [
            { title: 'Cantar Escalas', description: 'Praticar solfejo com escalas', type: 'pratica' },
            { title: 'Identificar Notas', description: 'Reconhecer notas por nome', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Pauta Musical e Claves - Onde Escrevemos a M√∫sica',
        description: 'Entenda a pauta musical e os diferentes tipos de claves',
        category: 'solfegio-basico',
        level: 'aprendiz',
        order: 3,
        points: 50,
        duration: 18,
        content: {
          theory: 'A pauta musical √© formada por 5 linhas e 4 espa√ßos onde escrevemos as notas. As claves determinam a altura das notas na pauta.',
          examples: [
            { title: 'Clave de Sol', description: 'Usada para instrumentos agudos' },
            { title: 'Clave de F√°', description: 'Usada para instrumentos graves' },
            { title: 'Posi√ß√£o das Notas', description: 'Como as notas se posicionam na pauta' }
          ],
          exercises: [
            { title: 'Desenhar Pautas', description: 'Criar pautas musicais', type: 'pratica' },
            { title: 'Identificar Claves', description: 'Reconhecer tipos de claves', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Figuras de Valor - A Dura√ß√£o das Notas',
        description: 'Aprenda sobre semibreve, m√≠nima, sem√≠nima e outras figuras',
        category: 'figuras-musicais',
        level: 'aprendiz',
        order: 4,
        points: 50,
        duration: 25,
        content: {
          theory: 'As figuras musicais representam a dura√ß√£o das notas. A semibreve vale 4 tempos, a m√≠nima vale 2, a sem√≠nima vale 1, e assim por diante.',
          examples: [
            { title: 'Semibreve', description: '4 tempos - nota mais longa' },
            { title: 'M√≠nima', description: '2 tempos - metade da semibreve' },
            { title: 'Sem√≠nima', description: '1 tempo - unidade b√°sica' },
            { title: 'Colcheia', description: '1/2 tempo - metade da sem√≠nima' }
          ],
          exercises: [
            { title: 'Contar Tempos', description: 'Praticar contagem r√≠tmica', type: 'pratica' },
            { title: 'Identificar Figuras', description: 'Reconhecer valores das notas', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Compassos Simples - Organizando o Tempo',
        description: 'Domine os compassos 2/4, 3/4 e 4/4',
        category: 'compasso-simples',
        level: 'aprendiz',
        order: 5,
        points: 50,
        duration: 22,
        content: {
          theory: 'O compasso divide a m√∫sica em unidades regulares de tempo. O numerador indica quantos tempos por compasso, o denominador indica a figura que vale 1 tempo.',
          examples: [
            { title: 'Compasso 4/4', description: '4 sem√≠nimas por compasso' },
            { title: 'Compasso 3/4', description: '3 sem√≠nimas por compasso' },
            { title: 'Compasso 2/4', description: '2 sem√≠nimas por compasso' }
          ],
          exercises: [
            { title: 'Bater Compassos', description: 'Praticar marca√ß√£o de compasso', type: 'pratica' },
            { title: 'Identificar Tipos', description: 'Reconhecer tipos de compasso', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Escalas Maiores - A Base da Harmonia',
        description: 'Aprenda a construir escalas maiores e suas f√≥rmulas',
        category: 'escalas-maiores',
        level: 'aprendiz',
        order: 6,
        points: 50,
        duration: 30,
        content: {
          theory: 'A escala maior √© formada pela sequ√™ncia: tom-tom-semitom-tom-tom-tom-semitom. √â a base da harmonia tonal ocidental.',
          examples: [
            { title: 'Escala de D√≥ Maior', description: 'C-D-E-F-G-A-B-C (sem acidentes)' },
            { title: 'Escala de Sol Maior', description: 'G-A-B-C-D-E-F#-G (1 sustenido)' },
            { title: 'F√≥rmula da Escala', description: 'T-T-ST-T-T-T-ST' }
          ],
          exercises: [
            { title: 'Construir Escalas', description: 'Criar escalas maiores', type: 'pratica' },
            { title: 'Identificar Acidentes', description: 'Reconhecer sustenidos e bem√≥is', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Din√¢mica Musical - Forte e Piano',
        description: 'Entenda os sinais de din√¢mica e express√£o',
        category: 'andamento-dinamica',
        level: 'aprendiz',
        order: 7,
        points: 50,
        duration: 15,
        content: {
          theory: 'A din√¢mica musical controla o volume e a intensidade. Os principais sinais s√£o: p (piano), f (forte), mf (mezzo forte), mp (mezzo piano).',
          examples: [
            { title: 'Sinais B√°sicos', description: 'pp, p, mp, mf, f, ff' },
            { title: 'Crescendo', description: 'Aumento gradual do volume' },
            { title: 'Diminuendo', description: 'Diminui√ß√£o gradual do volume' }
          ],
          exercises: [
            { title: 'Aplicar Din√¢mica', description: 'Usar sinais din√¢micos', type: 'pratica' },
            { title: 'Reconhecer Sinais', description: 'Identificar s√≠mbolos din√¢micos', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Acidentes Musicais - Sustenido e Bemol',
        description: 'Domine os acidentes e suas fun√ß√µes',
        category: 'figuras-musicais',
        level: 'aprendiz',
        order: 8,
        points: 50,
        duration: 20,
        content: {
          theory: 'Os acidentes alteram a altura das notas. Sustenido (#) sobe meio tom, bemol (b) desce meio tom, bequadro (‚ôÆ) cancela acidentes.',
          examples: [
            { title: 'Sustenido', description: 'D√≥# = R√©b (enarmonia)' },
            { title: 'Bemol', description: 'F√°# = Solb (enarmonia)' },
            { title: 'Bequadro', description: 'Cancela acidentes anteriores' }
          ],
          exercises: [
            { title: 'Identificar Acidentes', description: 'Reconhecer s√≠mbolos', type: 'teoria' },
            { title: 'Aplicar Altera√ß√µes', description: 'Usar acidentes em notas', type: 'pratica' }
          ]
        },
        isActive: true
      },

      // N√çVEL VIRTUOSO - 6 m√≥dulos
      {
        title: 'Escalas Menores - A Express√£o Musical',
        description: 'Aprenda escalas menores naturais, harm√¥nicas e mel√≥dicas',
        category: 'escalas-maiores',
        level: 'virtuoso',
        order: 1,
        points: 75,
        duration: 35,
        content: {
          theory: 'As escalas menores t√™m tr√™s formas: natural (tom-semitom-tom-tom-semitom-tom-tom), harm√¥nica (7¬™ elevada) e mel√≥dica (6¬™ e 7¬™ elevadas na subida).',
          examples: [
            { title: 'L√° Menor Natural', description: 'A-B-C-D-E-F-G-A' },
            { title: 'L√° Menor Harm√¥nica', description: 'A-B-C-D-E-F-G#-A' },
            { title: 'L√° Menor Mel√≥dica', description: 'A-B-C-D-E-F#-G#-A (subida)' }
          ],
          exercises: [
            { title: 'Construir Escalas Menores', description: 'Criar escalas menores', type: 'pratica' },
            { title: 'Identificar Tipos', description: 'Reconhecer formas de escala', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Intervalos Musicais - A Dist√¢ncia Entre as Notas',
        description: 'Domine intervalos consonantes e dissonantes',
        category: 'intervalos-musicais',
        level: 'virtuoso',
        order: 2,
        points: 75,
        duration: 40,
        content: {
          theory: 'Intervalo √© a dist√¢ncia entre duas notas. Classificamos por quantidade (un√≠ssono, 2¬™, 3¬™, etc.) e qualidade (maior, menor, justo, aumentado, diminuto).',
          examples: [
            { title: '3¬™ Maior', description: 'D√≥-Mi (2 tons)' },
            { title: '5¬™ Justa', description: 'D√≥-Sol (3,5 tons)' },
            { title: '7¬™ Menor', description: 'D√≥-Sib (5 tons)' }
          ],
          exercises: [
            { title: 'Identificar Intervalos', description: 'Reconhecer dist√¢ncias', type: 'audicao' },
            { title: 'Classificar Qualidades', description: 'Determinar tipos de intervalo', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Acordes B√°sicos - A Harmonia em A√ß√£o',
        description: 'Aprenda tr√≠ades maiores, menores e diminutas',
        category: 'intervalos-musicais',
        level: 'virtuoso',
        order: 3,
        points: 75,
        duration: 45,
        content: {
          theory: 'Acorde √© a combina√ß√£o simult√¢nea de tr√™s ou mais notas. A tr√≠ade b√°sica √© formada por t√¥nica, ter√ßa e quinta.',
          examples: [
            { title: 'D√≥ Maior', description: 'C-E-G (tr√≠ade maior)' },
            { title: 'L√° Menor', description: 'A-C-E (tr√≠ade menor)' },
            { title: 'Si Diminuto', description: 'B-D-F (tr√≠ade diminuta)' }
          ],
          exercises: [
            { title: 'Construir Tr√≠ades', description: 'Criar acordes b√°sicos', type: 'pratica' },
            { title: 'Identificar Tipos', description: 'Reconhecer qualidades', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Modos Gregos - As Cores da M√∫sica',
        description: 'Explore os 7 modos gregos e suas caracter√≠sticas',
        category: 'escalas-maiores',
        level: 'virtuoso',
        order: 4,
        points: 75,
        duration: 50,
        content: {
          theory: 'Os modos gregos s√£o escalas derivadas da escala maior, cada uma com sua caracter√≠stica √∫nica: J√¥nio, D√≥rico, Fr√≠gio, L√≠dio, Mixol√≠dio, E√≥lio, L√≥crio.',
          examples: [
            { title: 'Modo D√≥rico', description: 'R√©-D√≥ (2¬™ menor, 6¬™ menor)' },
            { title: 'Modo L√≠dio', description: 'F√°-Sol (4¬™ aumentada)' },
            { title: 'Modo Mixol√≠dio', description: 'Sol-F√° (7¬™ menor)' }
          ],
          exercises: [
            { title: 'Construir Modos', description: 'Criar escalas modais', type: 'pratica' },
            { title: 'Identificar Caracter√≠sticas', description: 'Reconhecer sons modais', type: 'audicao' }
          ]
        },
        isActive: true
      },
      {
        title: 'S√≠ncopa e Contratempo - Ritmo Avan√ßado',
        description: 'Domine ritmos sincopados e contratempos',
        category: 'sincopa-contratempo',
        level: 'virtuoso',
        order: 5,
        points: 75,
        duration: 30,
        content: {
          theory: 'S√≠ncopa √© o deslocamento do acento r√≠tmico. Contratempo √© a execu√ß√£o de notas nos tempos fracos.',
          examples: [
            { title: 'S√≠ncopa Simples', description: 'Acento no tempo fraco' },
            { title: 'Contratempo B√°sico', description: 'Notas nos tempos fracos' },
            { title: 'Padr√µes Complexos', description: 'Combina√ß√µes r√≠tmicas' }
          ],
          exercises: [
            { title: 'Executar S√≠ncopas', description: 'Praticar ritmos sincopados', type: 'pratica' },
            { title: 'Criar Contratempos', description: 'Desenvolver padr√µes r√≠tmicos', type: 'pratica' }
          ]
        },
        isActive: true
      },
      {
        title: 'Articula√ß√£o Musical - T√©cnicas de Execu√ß√£o',
        description: 'Aprenda staccato, legato, portato e outras articula√ß√µes',
        category: 'articulacao-musical',
        level: 'virtuoso',
        order: 6,
        points: 75,
        duration: 25,
        content: {
          theory: 'Articula√ß√£o √© a forma como as notas s√£o executadas: staccato (separado), legato (ligado), portato (semi-ligado), tenuto (sustentado).',
          examples: [
            { title: 'Staccato', description: 'Notas curtas e separadas (.)' },
            { title: 'Legato', description: 'Notas ligadas (curva)' },
            { title: 'Portato', description: 'Semi-ligado (ponto e linha)' }
          ],
          exercises: [
            { title: 'Aplicar Articula√ß√µes', description: 'Usar diferentes articula√ß√µes', type: 'pratica' },
            { title: 'Reconhecer Sinais', description: 'Identificar s√≠mbolos', type: 'teoria' }
          ]
        },
        isActive: true
      },

      // N√çVEL MAESTRO - 5 m√≥dulos
      {
        title: 'Harmonia Avan√ßada - A Orquestra√ß√£o Completa',
        description: 'Domine acordes de s√©tima, nona e extens√µes',
        category: 'expressao-musical',
        level: 'maestro',
        order: 1,
        points: 100,
        duration: 60,
        content: {
          theory: 'Harmonia avan√ßada inclui acordes de s√©tima (maior, menor, dominante, diminuto), nona, d√©cima primeira e d√©cima terceira, al√©m de substitui√ß√µes tr√≠tonas.',
          examples: [
            { title: 'Cmaj7', description: 'C-E-G-B (acorde de 7¬™ maior)' },
            { title: 'Dm7', description: 'D-F-A-C (acorde de 7¬™ menor)' },
            { title: 'G7', description: 'G-B-D-F (acorde de 7¬™ dominante)' }
          ],
          exercises: [
            { title: 'Construir Acordes Complexos', description: 'Criar acordes de 7¬™', type: 'pratica' },
            { title: 'Aplicar Substitui√ß√µes', description: 'Usar substitui√ß√µes tr√≠tonas', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Contraponto - A Arte da Voz Independente',
        description: 'Aprenda as regras do contraponto e fuga',
        category: 'expressao-musical',
        level: 'maestro',
        order: 2,
        points: 100,
        duration: 70,
        content: {
          theory: 'Contraponto √© a arte de combinar melodias independentes. Inclui movimento direto, contr√°rio, obl√≠quo, conson√¢ncias perfeitas e imperfeitas.',
          examples: [
            { title: 'C√¢none Simples', description: 'Imita√ß√£o a 2 vozes' },
            { title: 'Fuga B√°sica', description: 'Sujeito, resposta, contrasujeito' },
            { title: 'Contraponto a 2 Vozes', description: 'Regras b√°sicas' }
          ],
          exercises: [
            { title: 'Escrever Contraponto', description: 'Criar linhas independentes', type: 'pratica' },
            { title: 'Analisar Fugas', description: 'Estudar obras contrapont√≠sticas', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Orquestra√ß√£o - Pintando com Sons',
        description: 'Aprenda a orquestrar para diferentes instrumentos',
        category: 'compasso-composto',
        level: 'maestro',
        order: 3,
        points: 100,
        duration: 80,
        content: {
          theory: 'Orquestra√ß√£o √© a arte de distribuir material musical entre diferentes instrumentos, considerando tessitura, timbre, din√¢mica e textura.',
          examples: [
            { title: 'Se√ß√µes da Orquestra', description: 'Cordas, madeiras, metais, percuss√£o' },
            { title: 'Tessituras Instrumentais', description: 'Registros de cada instrumento' },
            { title: 'Efeitos Especiais', description: 'T√©cnicas orquestrais' }
          ],
          exercises: [
            { title: 'Orquestrar Melodias', description: 'Distribuir material musical', type: 'pratica' },
            { title: 'Criar Texturas', description: 'Desenvolver camadas sonoras', type: 'pratica' }
          ]
        },
        isActive: true
      },
      {
        title: 'Compasso Composto - 6/8, 9/8, 12/8',
        description: 'Domine os compassos compostos e suas subdivis√µes',
        category: 'compasso-composto',
        level: 'maestro',
        order: 4,
        points: 100,
        duration: 40,
        content: {
          theory: 'Compassos compostos t√™m subdivis√£o tern√°ria. O numerador indica o n√∫mero de subdivis√µes, o denominador indica a figura que vale uma subdivis√£o.',
          examples: [
            { title: '6/8', description: '2 grupos de 3 colcheias' },
            { title: '9/8', description: '3 grupos de 3 colcheias' },
            { title: '12/8', description: '4 grupos de 3 colcheias' }
          ],
          exercises: [
            { title: 'Bater Compassos Compostos', description: 'Praticar marca√ß√£o', type: 'pratica' },
            { title: 'Identificar Subdivis√µes', description: 'Reconhecer grupos tern√°rios', type: 'teoria' }
          ]
        },
        isActive: true
      },
      {
        title: 'Modula√ß√£o - Mudan√ßa de Tonalidade',
        description: 'Aprenda a modular entre diferentes tonalidades',
        category: 'expressao-musical',
        level: 'maestro',
        order: 5,
        points: 100,
        duration: 55,
        content: {
          theory: 'Modula√ß√£o √© a mudan√ßa de tonalidade durante uma pe√ßa musical. Pode ser direta, por acorde piv√¥, enarm√¥nica ou crom√°tica.',
          examples: [
            { title: 'Modula√ß√£o por 5¬™ Justa', description: 'D√≥ maior ‚Üí Sol maior' },
            { title: 'Acorde Piv√¥ Comum', description: 'Usar acorde comum √†s duas tonalidades' },
            { title: 'Modula√ß√£o Crom√°tica', description: 'Mudan√ßa por semitom' }
          ],
          exercises: [
            { title: 'Criar Modula√ß√µes', description: 'Desenvolver mudan√ßas tonais', type: 'pratica' },
            { title: 'Identificar Acordes Piv√¥', description: 'Reconhecer acordes comuns', type: 'teoria' }
          ]
        },
        isActive: true
      }
    ];

    const createdModules = await Module.insertMany(modules);
    console.log(`‚úÖ ${createdModules.length} m√≥dulos criados`);
    
    return createdModules;
  } catch (error) {
    console.error('‚ùå Erro ao criar m√≥dulos:', error);
    throw error;
  }
};

// Criar quizzes com 7 perguntas cada
const createQuizzesWithCorrectStructure = async (modules) => {
  try {
    console.log('üéØ Criando quizzes com estrutura correta...');
    
    const quizzes = [];
    
    modules.forEach(module => {
      const quiz = {
        title: `Quiz - ${module.title}`,
        description: `Teste seus conhecimentos sobre ${module.title.toLowerCase()}`,
        moduleId: module._id,
        level: module.level,
        category: module.category,
        questions: generateQuestionsForModule(module),
        isActive: true
      };
      
      quizzes.push(quiz);
    });

    const createdQuizzes = await Quiz.insertMany(quizzes);
    console.log(`‚úÖ ${createdQuizzes.length} quizzes criados`);
    
    return createdQuizzes;
  } catch (error) {
    console.error('‚ùå Erro ao criar quizzes:', error);
    throw error;
  }
};

// Gerar 7 perguntas espec√≠ficas para cada m√≥dulo
const generateQuestionsForModule = (module) => {
  const questions = [];
  
  // Perguntas baseadas no n√≠vel e categoria do m√≥dulo
  if (module.level === 'aprendiz') {
    questions.push(
      {
        question: `Qual √© o principal objetivo do m√≥dulo "${module.title}"?`,
        options: [
          'Aprender conceitos b√°sicos de m√∫sica',
          'Dominar t√©cnicas avan√ßadas',
          'Criar composi√ß√µes complexas',
          'Tocar instrumentos virtuais'
        ],
        correctAnswer: 0,
        explanation: 'Este m√≥dulo foca nos conceitos fundamentais da m√∫sica.',
        difficulty: 'facil'
      },
      {
        question: `Para qual n√≠vel este m√≥dulo √© indicado?`,
        options: ['Aprendiz', 'Virtuoso', 'Maestro', 'Todos os n√≠veis'],
        correctAnswer: 0,
        explanation: 'Este m√≥dulo √© espec√≠fico para o n√≠vel Aprendiz.',
        difficulty: 'facil'
      },
      {
        question: `Quantos pontos voc√™ ganha completando este m√≥dulo?`,
        options: ['25 pontos', '50 pontos', '75 pontos', '100 pontos'],
        correctAnswer: 1,
        explanation: `Este m√≥dulo vale ${module.points} pontos.`,
        difficulty: 'facil'
      },
      {
        question: `Qual categoria musical este m√≥dulo aborda?`,
        options: [
          module.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
          'Harmonia avan√ßada',
          'Composi√ß√£o cl√°ssica',
          'Improvisa√ß√£o jazz'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo pertence √† categoria ${module.category}.`,
        difficulty: 'medio'
      },
      {
        question: `Qual √© a dura√ß√£o estimada deste m√≥dulo?`,
        options: [
          `${module.duration} minutos`,
          '1 hora',
          '2 horas',
          '30 minutos'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo tem dura√ß√£o estimada de ${module.duration} minutos.`,
        difficulty: 'facil'
      },
      {
        question: `Este m√≥dulo √© adequado para iniciantes em m√∫sica?`,
        options: ['Sim, √© b√°sico', 'N√£o, √© avan√ßado', 'Depende do instrumento', 'Apenas para teoria'],
        correctAnswer: 0,
        explanation: 'Como √© um m√≥dulo de n√≠vel Aprendiz, √© adequado para iniciantes.',
        difficulty: 'facil'
      },
      {
        question: `Qual habilidade voc√™ desenvolver√° neste m√≥dulo?`,
        options: [
          'Fundamentos musicais',
          'T√©cnicas virtuos√≠sticas',
          'Composi√ß√£o orquestral',
          'Improvisa√ß√£o complexa'
        ],
        correctAnswer: 0,
        explanation: 'Este m√≥dulo desenvolve os fundamentos b√°sicos da m√∫sica.',
        difficulty: 'medio'
      }
    );
  } else if (module.level === 'virtuoso') {
    questions.push(
      {
        question: `Qual √© o n√≠vel de complexidade do m√≥dulo "${module.title}"?`,
        options: ['B√°sico', 'Intermedi√°rio', 'Avan√ßado', 'Profissional'],
        correctAnswer: 1,
        explanation: 'Este m√≥dulo √© de n√≠vel intermedi√°rio (Virtuoso).',
        difficulty: 'medio'
      },
      {
        question: `Para qual n√≠vel este m√≥dulo √© indicado?`,
        options: ['Aprendiz', 'Virtuoso', 'Maestro', 'Todos os n√≠veis'],
        correctAnswer: 1,
        explanation: 'Este m√≥dulo √© espec√≠fico para o n√≠vel Virtuoso.',
        difficulty: 'facil'
      },
      {
        question: `Quantos pontos voc√™ ganha completando este m√≥dulo?`,
        options: ['50 pontos', '75 pontos', '100 pontos', '125 pontos'],
        correctAnswer: 1,
        explanation: `Este m√≥dulo vale ${module.points} pontos.`,
        difficulty: 'facil'
      },
      {
        question: `Este m√≥dulo requer conhecimento pr√©vio?`,
        options: ['Sim, conceitos b√°sicos', 'N√£o, √© independente', 'Apenas teoria', 'S√≥ pr√°tica'],
        correctAnswer: 0,
        explanation: 'M√≥dulos Virtuoso requerem conhecimento dos conceitos b√°sicos.',
        difficulty: 'medio'
      },
      {
        question: `Qual √© a dura√ß√£o estimada deste m√≥dulo?`,
        options: [
          `${module.duration} minutos`,
          '1 hora',
          '2 horas',
          '30 minutos'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo tem dura√ß√£o estimada de ${module.duration} minutos.`,
        difficulty: 'facil'
      },
      {
        question: `Este m√≥dulo desenvolve habilidades espec√≠ficas?`,
        options: ['Sim, t√©cnicas intermedi√°rias', 'N√£o, √© geral', 'Apenas te√≥ricas', 'S√≥ pr√°ticas'],
        correctAnswer: 0,
        explanation: 'M√≥dulos Virtuoso desenvolvem t√©cnicas e conceitos intermedi√°rios.',
        difficulty: 'medio'
      },
      {
        question: `Qual categoria musical este m√≥dulo aborda?`,
        options: [
          module.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
          'Fundamentos b√°sicos',
          'Composi√ß√£o avan√ßada',
          'Improvisa√ß√£o livre'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo pertence √† categoria ${module.category}.`,
        difficulty: 'medio'
      }
    );
  } else if (module.level === 'maestro') {
    questions.push(
      {
        question: `Qual √© o n√≠vel de complexidade do m√≥dulo "${module.title}"?`,
        options: ['B√°sico', 'Intermedi√°rio', 'Avan√ßado', 'Profissional'],
        correctAnswer: 2,
        explanation: 'Este m√≥dulo √© de n√≠vel avan√ßado (Maestro).',
        difficulty: 'dificil'
      },
      {
        question: `Para qual n√≠vel este m√≥dulo √© indicado?`,
        options: ['Aprendiz', 'Virtuoso', 'Maestro', 'Todos os n√≠veis'],
        correctAnswer: 2,
        explanation: 'Este m√≥dulo √© espec√≠fico para o n√≠vel Maestro.',
        difficulty: 'facil'
      },
      {
        question: `Quantos pontos voc√™ ganha completando este m√≥dulo?`,
        options: ['75 pontos', '100 pontos', '125 pontos', '150 pontos'],
        correctAnswer: 1,
        explanation: `Este m√≥dulo vale ${module.points} pontos.`,
        difficulty: 'facil'
      },
      {
        question: `Este m√≥dulo requer conhecimento avan√ßado?`,
        options: ['Sim, conceitos complexos', 'N√£o, √© b√°sico', 'Apenas teoria', 'S√≥ pr√°tica'],
        correctAnswer: 0,
        explanation: 'M√≥dulos Maestro requerem conhecimento avan√ßado de m√∫sica.',
        difficulty: 'medio'
      },
      {
        question: `Qual √© a dura√ß√£o estimada deste m√≥dulo?`,
        options: [
          `${module.duration} minutos`,
          '1 hora',
          '2 horas',
          '30 minutos'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo tem dura√ß√£o estimada de ${module.duration} minutos.`,
        difficulty: 'facil'
      },
      {
        question: `Este m√≥dulo desenvolve habilidades profissionais?`,
        options: ['Sim, t√©cnicas avan√ßadas', 'N√£o, √© b√°sico', 'Apenas te√≥ricas', 'S√≥ pr√°ticas'],
        correctAnswer: 0,
        explanation: 'M√≥dulos Maestro desenvolvem habilidades profissionais avan√ßadas.',
        difficulty: 'dificil'
      },
      {
        question: `Qual categoria musical este m√≥dulo aborda?`,
        options: [
          module.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
          'Fundamentos b√°sicos',
          'T√©cnicas intermedi√°rias',
          'Improvisa√ß√£o livre'
        ],
        correctAnswer: 0,
        explanation: `Este m√≥dulo pertence √† categoria ${module.category}.`,
        difficulty: 'medio'
      }
    );
  }
  
  return questions;
};

// Fun√ß√£o principal
const fixContentStructure = async () => {
  try {
    console.log('üöÄ CORRIGINDO ESTRUTURA DO CONTE√öDO');
    console.log('=' .repeat(60));

    // 1. Limpar dados existentes
    await clearExistingData();

    // 2. Criar m√≥dulos com estrutura correta
    const modules = await createModulesWithCorrectStructure();

    // 3. Criar quizzes com estrutura correta
    const quizzes = await createQuizzesWithCorrectStructure(modules);

    // 4. Verificar resultado
    console.log('\nüìä RESULTADO FINAL:');
    console.log('-' .repeat(40));
    
    const totalModules = await Module.countDocuments();
    const totalQuizzes = await Quiz.countDocuments();
    const totalQuestions = await Quiz.aggregate([
      { $project: { questionCount: { $size: "$questions" } } },
      { $group: { _id: null, total: { $sum: "$questionCount" } } }
    ]);

    console.log(`üìö Total de m√≥dulos: ${totalModules}`);
    console.log(`üéØ Total de quizzes: ${totalQuizzes}`);
    console.log(`‚ùì Total de perguntas: ${totalQuestions[0]?.total || 0}`);

    // Distribui√ß√£o por n√≠vel
    const levelStats = await Module.aggregate([
      { $group: { _id: "$level", count: { $sum: 1 } } },
      { $sort: { _id: 1 } }
    ]);

    console.log('\nüìà DISTRIBUI√á√ÉO POR N√çVEL:');
    levelStats.forEach(stat => {
      console.log(`   üéØ ${stat._id.toUpperCase()}: ${stat.count} m√≥dulos`);
    });

    // Perguntas por n√≠vel
    const questionsByLevel = await Quiz.aggregate([
      { $project: { level: 1, questionCount: { $size: "$questions" } } },
      { $group: { _id: "$level", total: { $sum: "$questionCount" } } },
      { $sort: { _id: 1 } }
    ]);

    console.log('\n‚ùì PERGUNTAS POR N√çVEL:');
    questionsByLevel.forEach(stat => {
      console.log(`   üéØ ${stat._id.toUpperCase()}: ${stat.total} perguntas`);
    });

    console.log('\nüéâ ESTRUTURA CORRIGIDA COM SUCESSO!');
    console.log('=' .repeat(60));

  } catch (error) {
    console.error('‚ùå Erro durante a corre√ß√£o:', error);
  } finally {
    await mongoose.disconnect();
    console.log('\nüîå Desconectado do MongoDB');
    process.exit(0);
  }
};

// Executar se chamado diretamente
if (require.main === module) {
  connectDB().then(fixContentStructure);
}

module.exports = { fixContentStructure };



